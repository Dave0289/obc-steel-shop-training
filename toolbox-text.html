<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Safety Toolbox Talk</title>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --btn:#2563eb;
      --btn2:#111827;
      --border:#e5e7eb;
      --radius:16px;
      --shadow:0 12px 35px rgba(0,0,0,.12);

      /* banners */
      --ok-bg:#dcfce7;
      --ok-border:#22c55e;
      --ok-text:#166534;

      --warn-bg:#fffbeb;
      --warn-border:#f59e0b;
      --warn-text:#92400e;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
      padding:16px;
    }

    .wrap{
      width:min(980px, 100%);
      margin:0 auto;
    }

    .banner{
      display:none;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:14px;
      font-size:14px;
      font-weight:650;
      line-height:1.25;
    }

    .banner.ok{
      background:var(--ok-bg);
      border:1px solid var(--ok-border);
      color:var(--ok-text);
    }

    .banner.warn{
      background:var(--warn-bg);
      border:1px solid var(--warn-border);
      color:var(--warn-text);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    h1{
      margin:0;
      font-size:22px;
    }

    .back{
      text-decoration:none;
      color:var(--ink);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      font-size:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .talk{
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:#fafafa;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      line-height:1.35;
      font-size:15px;
      min-height:200px;
    }

    .form{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    label{
      font-size:14px;
      color:var(--muted);
    }

    input[type="text"]{
      width:100%;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:16px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .row input{
      margin-top:4px;
      transform:scale(1.2);
    }

    .btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:12px;
      background:var(--btn);
      color:#fff;
      font-size:16px;
      cursor:pointer;
    }

    .btn.secondary{
      background:var(--btn2);
    }

    .manual{
      display:none;
      margin-top:12px;
      padding:12px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:#fff;
    }

    .manual p{
      margin:0 0 8px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    textarea{
      width:100%;
      min-height:160px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:13px;
      resize:vertical;
    }

    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div id="okMsg" class="banner ok">
      ✔ Email draft opened. <b>Press SEND</b> to complete your acknowledgment.
    </div>

    <div id="warnMsg" class="banner warn">
      ⚠ Your device didn’t open an email draft. Use the manual copy method below.
    </div>

    <div class="topbar">
      <h1>Weekly Safety Toolbox Talk</h1>
      <a class="back" href="/index.html">← Back to Portal</a>
    </div>

    <div class="card">
      <div id="talk" class="talk">Loading toolbox talk…</div>

      <div class="form">
        <div>
          <label for="name">Employee Name</label>
          <input id="name" type="text" placeholder="Type your full name" />
        </div>

        <div class="row">
          <input id="ack" type="checkbox" />
          <label for="ack">
            I acknowledge that I have read and understood today’s Weekly Safety Toolbox Talk.
          </label>
        </div>

        <button class="btn" type="button" onclick="attemptEmail()">Send Acknowledgment</button>

        <button class="btn secondary" type="button" onclick="showManual()">
          Having trouble? Open manual copy method
        </button>

        <div id="manualBox" class="manual">
          <p><b>Manual method:</b> Open your email app, create a new email to <b>dave@ogdenbrothers.com</b>,
            then paste the text below. Subject is shown at the top of the text.</p>
          <textarea id="manualText" readonly></textarea>
          <button class="btn" type="button" onclick="copyManual()">Copy Email Text</button>
          <div class="small">If “Copy” doesn’t work on your device, press and hold to select all, then copy.</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const EMAIL_TO = "dave@ogdenbrothers.com";
    const TALK_FILE = "toolbox-talk.txt";
    let talkText = "";

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function loadTalk(){
      try{
        const res = await fetch(`${TALK_FILE}?v=${Date.now()}`, { cache:"no-store" });
        talkText = await res.text();
        document.getElementById("talk").textContent =
          talkText.trim() || "(Toolbox talk file is empty)";
      }catch{
        talkText = "";
        document.getElementById("talk").textContent =
          "ERROR: toolbox-talk.txt not found.";
      }
    }

    function buildEmail(name){
      const date = todayISO();
      const subject = `OBC Safety Training - Weekly Toolbox Talk - ${name} - ${date}`;
      const body =
`Employee Name: ${name}
Date: ${date}

I acknowledge that I have read and understood today’s Weekly Safety Toolbox Talk.

------------------------------------
${talkText || "(Toolbox talk text not loaded.)"}
`;
      return { subject, body };
    }

    function setBanners(ok, warn){
      document.getElementById("okMsg").style.display = ok ? "block" : "none";
      document.getElementById("warnMsg").style.display = warn ? "block" : "none";
    }

    function showManual(){
      document.getElementById("manualBox").style.display = "block";
    }

    function fillManualText(name){
      const { subject, body } = buildEmail(name);
      document.getElementById("manualText").value =
`SUBJECT: ${subject}

TO: ${EMAIL_TO}

${body}`;
    }

    async function copyManual(){
      const ta = document.getElementById("manualText");
      ta.focus();
      ta.select();
      try{
        await navigator.clipboard.writeText(ta.value);
        alert("Copied. Now paste into a new email and press Send.");
      }catch{
        document.execCommand("copy");
        alert("Copied (or selected). Now paste into a new email and press Send.");
      }
    }

    function attemptEmail(){
      const name = document.getElementById("name").value.trim();
      const ack  = document.getElementById("ack").checked;

      if(!name){
        alert("Please enter your name.");
        return;
      }
      if(!ack){
        alert("Please check the acknowledgment box.");
        return;
      }

      const { subject, body } = buildEmail(name);

      // Always prepare manual fallback text
      fillManualText(name);

      // Try mailto
      const mailto =
        `mailto:${encodeURIComponent(EMAIL_TO)}` +
        `?subject=${encodeURIComponent(subject)}` +
        `&body=${encodeURIComponent(body)}`;

      // We can't truly verify sending, but we can guide properly.
      // Show "draft opened" message immediately.
      setBanners(true, false);

      // Some environments block mailto; if it doesn't open, user can use manual box.
      // We'll still show the manual option right away.
      showManual();

      // Trigger email client
      window.location.href = mailto;

      // If they come back and it didn't open, they still have the manual copy path.
      // (No reliable browser signal exists to detect failure.)
    }

    loadTalk();
  </script>
</body>
</html>
