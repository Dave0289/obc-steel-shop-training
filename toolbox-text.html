<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Safety Toolbox Talk</title>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --btn:#2563eb;
      --border:#e5e7eb;
      --radius:16px;
      --shadow:0 12px 35px rgba(0,0,0,.12);

      --ok-bg:#dcfce7;
      --ok-border:#22c55e;
      --ok-text:#166534;

      --err-bg:#fee2e2;
      --err-border:#ef4444;
      --err-text:#991b1b;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
      padding:16px;
    }

    .wrap{ width:min(980px, 100%); margin:0 auto; }

    .banner{
      display:none;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:14px;
      font-size:14px;
      font-weight:650;
      line-height:1.25;
    }
    .banner.ok{
      background:var(--ok-bg);
      border:1px solid var(--ok-border);
      color:var(--ok-text);
    }
    .banner.err{
      background:var(--err-bg);
      border:1px solid var(--err-border);
      color:var(--err-text);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    h1{ margin:0; font-size:22px; }

    .back{
      text-decoration:none;
      color:var(--ink);
      border:1px solid var(--border);
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      font-size:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .talk{
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:#fafafa;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      line-height:1.35;
      font-size:15px;
      min-height:200px;
    }

    .form{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    label{ font-size:14px; color:var(--muted); }

    input[type="text"]{
      width:100%;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:16px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .row input{
      margin-top:4px;
      transform:scale(1.2);
    }

    .btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:12px;
      background:var(--btn);
      color:#fff;
      font-size:16px;
      cursor:pointer;
    }

    .small{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div id="okMsg" class="banner ok">✔ Submitted</div>
    <div id="errMsg" class="banner err">✖ Submission failed. Try again, or call Dave.</div>

    <div class="topbar">
      <h1>Weekly Safety Toolbox Talk</h1>
      <a class="back" href="/index.html">← Back to Portal</a>
    </div>

    <div class="card">
      <div id="talk" class="talk">Loading toolbox talk…</div>

      <!-- Netlify Forms (server-side, no user email required) -->
      <form
        name="weekly-toolbox-talk"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        action="/"
        onsubmit="handleSubmit(event)"
        class="form"
      >
        <!-- required for Netlify form name -->
        <input type="hidden" name="form-name" value="weekly-toolbox-talk" />

        <!-- spam trap -->
        <p style="display:none;">
          <label>Don’t fill this out: <input name="bot-field" /></label>
        </p>

        <!-- captured fields -->
        <div>
          <label for="employee_name">Employee Name</label>
          <input id="employee_name" name="employee_name" type="text" placeholder="Type your full name" required />
        </div>

        <!-- optional fields if you want them in email subject/filters -->
        <input type="hidden" id="talk_date" name="talk_date" />
        <input type="hidden" id="talk_title" name="talk_title" value="Weekly Toolbox Talk" />

        <!-- store the actual talk text inside the submission -->
        <input type="hidden" id="talk_text" name="talk_text" />

        <div class="row">
          <input id="ack" name="acknowledged" type="checkbox" value="Yes" required />
          <label for="ack">
            I acknowledge that I have read and understood today’s Weekly Safety Toolbox Talk.
          </label>
        </div>

        <button id="submitBtn" class="btn" type="submit">Submit Acknowledgment</button>

        <div class="small">
          This submits directly to the OBC portal system (no personal email required).
        </div>
      </form>
    </div>
  </div>

  <script>
    const TALK_FILE = "toolbox-talk.txt";

    function setBanner(ok, err){
      document.getElementById("okMsg").style.display = ok ? "block" : "none";
      document.getElementById("errMsg").style.display = err ? "block" : "none";
      if(ok) window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function loadTalk(){
      try{
        const res = await fetch(`${TALK_FILE}?v=${Date.now()}`, { cache:"no-store" });
        const txt = await res.text();

        const cleaned = (txt || "").trim();
        document.getElementById("talk").textContent = cleaned || "(Toolbox talk file is empty.)";

        // put it into hidden field so Netlify emails you the actual content
        document.getElementById("talk_text").value = cleaned;

        // set date hidden field
        document.getElementById("talk_date").value = todayISO();
      }catch(e){
        document.getElementById("talk").textContent =
          "ERROR: toolbox-talk.txt not found.";
        document.getElementById("talk_text").value = "";
        document.getElementById("talk_date").value = todayISO();
      }
    }

    // Netlify AJAX submit (recommended pattern)
    function encodeFormData(form){
      const formData = new FormData(form);
      return new URLSearchParams(formData).toString();
    }

    function handleSubmit(event){
      event.preventDefault();

      const form = event.target;
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;

      setBanner(false, false);

      fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: encodeFormData(form)
      })
      .then(() => {
        setBanner(true, false);
        form.reset();

        // reload talk fields after reset (so talk_text and talk_date are re-filled)
        loadTalk();

        // re-enable after a moment
        setTimeout(() => { btn.disabled = false; }, 800);
      })
      .catch(() => {
        setBanner(false, true);
        btn.disabled = false;
      });
    }

    loadTalk();
  </script>
</body>
</html>
