<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OBC Steel Shop Training – Weekly Toolbox Talk</title>
  <meta name="description" content="OBC Weekly Safety Toolbox Talk Acknowledgment" />

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#1f2937;
      --btn:#2563eb;
      --btnHover:#1d4ed8;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 16px;

      --ok-bg:#dcfce7;
      --ok-border:#22c55e;
      --ok-text:#166534;

      --err-bg:#fee2e2;
      --err-border:#ef4444;
      --err-text:#991b1b;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      padding: 18px;
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .titleBlock h1{
      margin:0;
      font-size: 22px;
      line-height:1.2;
      color: var(--brand);
    }

    .titleBlock p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .back{
      text-decoration:none;
      color: var(--brand);
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:14px;
      line-height:1;
    }

    .banner{
      display:none;
      padding:12px 14px;
      border-radius:12px;
      margin: 0 0 12px 0;
      font-weight:700;
      font-size:14px;
    }
    .banner.ok{
      background: var(--ok-bg);
      border: 1px solid var(--ok-border);
      color: var(--ok-text);
    }
    .banner.err{
      background: var(--err-bg);
      border: 1px solid var(--err-border);
      color: var(--err-text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .label{
      display:block;
      margin: 14px 0 6px 0;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      font-size:16px;
      border:1px solid var(--border);
      border-radius: 12px;
      outline:none;
      background:#fff;
    }

    .scrollBox{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fafafa;
      padding:12px;
      height: 320px;             /* scroll area */
      overflow-y:auto;
      white-space:pre-wrap;       /* keep formatting but wrap */
      overflow-wrap:anywhere;
      line-height:1.35;
      font-size: 15px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }

    .row input{
      margin-top:4px;
      transform: scale(1.2);
    }

    .row label{
      margin:0;
      font-size: 14px;
      color: var(--ink);
    }

    .btn{
      margin-top: 14px;
      width:100%;
      padding: 12px 14px;
      border:none;
      border-radius: 12px;
      background: var(--btn);
      color:#fff;
      font-size: 16px;
      font-weight: 700;
      cursor:pointer;
    }
    .btn:hover{ background: var(--btnHover); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .small{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div id="okMsg" class="banner ok">✔ Submitted</div>
    <div id="errMsg" class="banner err">✖ Submission failed. Try again.</div>

    <div class="header">
      <div class="titleBlock">
        <h1>Weekly Safety Toolbox Talk</h1>
        <p>Read the talk below, then enter your name and acknowledge completion.</p>
      </div>
      <a class="back" href="/index.html">← Back to Portal</a>
    </div>

    <div class="card">

      <!-- SCROLLING TOOLBOX TALK -->
      <span class="label">Toolbox Talk (English + Español)</span>
      <div id="talkBox" class="scrollBox">Loading toolbox talk…</div>

      <!-- NETLIFY FORM (server-side like your modules) -->
      <form
        name="steelshop-toolbox-talk"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        action="/"
        onsubmit="handleSubmit(event)"
      >
        <input type="hidden" name="form-name" value="steelshop-toolbox-talk" />
        <p style="display:none;">
          <label>Don’t fill this out: <input name="bot-field" /></label>
        </p>

        <!-- hidden metadata (helps you sort submissions) -->
        <input type="hidden" id="module_name" name="module_name" value="Weekly Safety Toolbox Talk" />
        <input type="hidden" id="submit_date" name="submit_date" />
        <input type="hidden" id="page_path" name="page_path" />
        <input type="hidden" id="toolbox_text" name="toolbox_text" />

        <span class="label">Employee Name</span>
        <input id="employee_name" name="employee_name" type="text" required placeholder="Type your full name" />

        <div class="row">
          <input id="ack" name="acknowledged" type="checkbox" value="Yes" required />
          <label for="ack">
            I acknowledge that I have read and understood today’s Weekly Safety Toolbox Talk.
          </label>
        </div>

        <button id="submitBtn" class="btn" type="submit">Submit</button>

        <div class="small">
          This submits directly through the training portal (no personal email needed).
        </div>
      </form>
    </div>
  </div>

  <script>
    const TALK_FILE = "toolbox-talk.txt";
    let talkText = "";

    function setBanner(ok, err){
      document.getElementById("okMsg").style.display = ok ? "block" : "none";
      document.getElementById("errMsg").style.display = err ? "block" : "none";
      if(ok || err) window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function loadTalk(){
      try{
        const res = await fetch(`${TALK_FILE}?v=${Date.now()}`, { cache:"no-store" });
        if(!res.ok) throw new Error("fetch failed");
        talkText = await res.text();
        talkText = (talkText || "").trim();
        document.getElementById("talkBox").textContent = talkText || "(Toolbox talk file is empty.)";
      }catch(e){
        talkText = "";
        document.getElementById("talkBox").textContent =
          "ERROR: Could not load toolbox-talk.txt\n\n" +
          "Make sure toolbox-talk.txt is in the same folder as this page.";
      }

      // Fill hidden fields
      document.getElementById("submit_date").value = todayISO();
      document.getElementById("page_path").value = location.pathname || "/toolbox.html";
      document.getElementById("toolbox_text").value = talkText;
    }

    function encodeForm(form){
      const data = new FormData(form);
      return new URLSearchParams(data).toString();
    }

    function handleSubmit(event){
      event.preventDefault();

      const form = event.target;
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      setBanner(false, false);

      // IMPORTANT: this must POST to "/" for Netlify to capture it
      fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: encodeForm(form)
      })
      .then(() => {
        setBanner(true, false);
        form.reset();

        // reload the talk + hidden fields after reset
        loadTalk();

        // re-enable quickly
        setTimeout(() => { btn.disabled = false; }, 700);
      })
      .catch(() => {
        setBanner(false, true);
        btn.disabled = false;
      });
    }

    loadTalk();
  </script>
</body>
</html>
